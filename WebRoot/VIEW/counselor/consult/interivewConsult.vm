#set($consultant=$session.getAttribute("SESSION_CONSULTANT_OBJECT"))
<link href="$link.contextPath/STATIC/plugin/umeditor/themes/default/css/umeditor.css" type="text/css" rel="stylesheet">
<script type="text/javascript" src="$link.contextPath/STATIC/plugin/umeditor/umeditor.config.js"></script>
<!-- 编辑器源码文件 -->
<script type="text/javascript" src="$link.contextPath/STATIC/plugin/umeditor/umeditor.js"></script>
<!-- 语言包文件(建议手动加载语言包，避免在ie下，因为加载语言失败导致编辑器加载失败) -->
<script type="text/javascript" src="$link.contextPath/STATIC/plugin/umeditor/lang/zh-cn/zh-cn.js"></script>  
#parse("counselor/counselorGuide.vm")
#set($counselorVO=$consultBase.counselorVO)
#set($consultant=$consultBase.consultant)
<div class="alert alert-dismissable alert-info">
  	<p>当前记录状态:<span style="font-size:20px;color:red">$enumUtil.getEnumClass("com.ccconsult.enums.ConsultStepEnum").getByValue($consultBase.consult.step).getDescription()</span></p>
  	
  	#if($consultBase.consult.step==1)
  			<p>	您可以有如下选择：
			<button  class="btn btn-primary btn-sm" onclick="acceptConsult($consultBase.consult.id)"><span class="glyphicon glyphicon-ok"></span> 接受预约</button>
			<button  class="btn btn-warning btn-sm" data-toggle="modal" data-target="#rejectInnerConsult" ><span class="glyphicon glyphicon-remove"></span> 拒绝预约</button>
			</p>		
	#end
	#if($consultBase.consult.step==2)
			<p>	您可以有如下选择：
			<button  class="btn btn-primary btn-sm" onclick="completeConsult($consultBase.consult.id)"><span class="glyphicon glyphicon-stop"></span> 结束咨询</button>
			</p>
	#end
</div>

<div class="row">
	<div class="col-sm-12">
		<div class="panel panel-default">
		  <div class="panel-heading"><span class="glyphicon glyphicon-user"></span>咨询者信息</div>
		  <div class="panel-body">
		  		<div class="col-sm-12">
                  	<div class="col-sm-1">
                        <img src="$link.contextPath/UPLOAD/$!consultant.photo" class="img-rounded" style="width: 82px;height: 82px;">
                    </div>
                    <div class="col-sm-11">
	                    <p class="col-sm-12"><span class=" text-right col-sm-2">名称:</span>$!consultant.name</p>
	                    <p class="col-sm-12"><span class=" text-right col-sm-2">邮箱:</span>$!consultant.email</p>
	                    <p class="col-sm-12"><span class=" text-right col-sm-2">手机号码:</span>$!consultant.mobile</p>
                    </div>
                </div>	
		  </div>
  		</div>
	</div>
</div>	

<div class="row">
	<div class="col-sm-12">
		<div class="panel panel-default">
		  <div class="panel-heading"><span class="glyphicon glyphicon-bookmark"></span>咨询问题描述</div>
		  <div class="panel-body">
		  		$consultBase.consult.goal
		  </div>
  		</div>
	</div>
</div>
<div class="row">
	<div class="col-sm-12">
		<div class="panel panel-default">
		  <div class="panel-heading"><span class="glyphicon glyphicon-comment"></span> 留言记录</div>
		  <div class="panel-body">
		  	#foreach($messageVO in $messageVOs)
		  		#if($messageVO.message.creatorRole==2)
			  		<div class="col-sm-12">
				  		<div class="col-sm-1">
				  			<img src="$link.contextPath/UPLOAD/$consultant.photo" class="img-rounded" style="width: 60px;height: 60px;">
				  		</div>
				  		<div class="col-sm-11">
				  			<div class="col-sm-10  text-left" >
					  			<div class="panel panel-default">
								  <div class="panel-body">
								  		<p class="text-primary" style="border-bottom:solid 1px #ddd">咨询者：$consultant.name    <span style="float:right;">
								  		创建时间 $date.format("yyyy-MM-dd HH:mm:ss", $messageVO.message.gmtCreate)</span></p>
								  		$messageVO.message.message
								  </div>
								</div>
							</div>
				  		</div>
				  	</div>
		  		#elseif($messageVO.message.creatorRole==1)
			  		<div class="col-sm-12">
				  		<div class="col-sm-11">
				  			<div class="col-sm-10  text-right col-sm-offset-2" >
					  			<div class="panel panel-default">
								  <div class="panel-body">
								  		<p class="text-primary" style="border-bottom:solid 1px #ddd">我 <span style="float:left;">
								  		创建时间 $date.format("yyyy-MM-dd HH:mm:ss", $messageVO.message.gmtCreate)</span></p>
								  		$messageVO.message.message
								  </div>
								</div>
							</div>
				  		</div>
				  		<div class="col-sm-1">
				  			<img src="$link.contextPath/UPLOAD/$!counselorVO.counselor.photo" class="img-rounded" style="width: 60px;height: 60px;">
				  		</div>				  		
				  	</div>
		  		#end
		  	#end
		  	#if($consultBase.consult.step==2)
		  	<form id="sendMessageForm">
			<div class="col-sm-12">
				<hr/>
                <script type="text/plain" id="myEditor" name="message" style="width:100%;height:200px;"></script>
                <script type="text/javascript">
				    $(function(){
				        window.um = UM.getEditor('myEditor', {
				            /* 传入配置参数,可配参数列表看umeditor.config.js */
				            toolbar: ['undo redo | bold italic underline']
				        });
				    });
                </script>   
                <br/>
                <input type="hidden" name="creatorRole" value="1"/>
                <input type="hidden" name="creator"  value="$counselorVO.counselor.id"/>
                <input type="hidden" name="relId" value="$consultBase.consult.id"/>
			   <button type="button" class="btn btn-danger col-sm-2" style="float:right;" onclick="sendMessage()">留言</button>
		  	</div>
		  	</form>
		  	#end
		  </div>
		</div>
	</div>
</div>
#if($consultBase.apprises.size()>0)
<div class="row">
	<div class="col-sm-12">
		<div class="panel panel-default">
		  <div class="panel-heading"><span class="glyphicon glyphicon-pushpin"></span>评价信息</div>
		  <div class="panel-body">
		  	#foreach($apprise in $!consultBase.apprises)
				#if($apprise.creatorRole==2)
			  		<div class="col-sm-12">
				  		<div class="col-sm-1">
				  			<img src="$link.contextPath/UPLOAD/$consultant.photo" class="img-rounded" style="width: 60px;height: 60px;">
				  		</div>
				  		<div class="col-sm-11">
				  			<div class="col-sm-10  text-left" >
					  			<div class="panel panel-default">
								  <div class="panel-body">
								  		<p class="text-primary" style="border-bottom:solid 1px #ddd">
								  		<span class="label label-info">
								  		评价：$enumUtil.getEnumClass("com.ccconsult.enums.AppriseEnum").getByValue($apprise.apprise).getDescription()
								  		</span>
								  		<span style="float:right;">
								  		创建时间 $date.format("yyyy-MM-dd HH:mm:ss", $apprise.gmtCreate)</span></p>
								  		#if($apprise.memo) $apprise.memo  #else 他很懒，什么也没有写  #end
								  </div>
								</div>
							</div>
				  		</div>
				  	</div>
		  		#elseif($apprise.creatorRole==1)
			  		<div class="col-sm-12">	  		
				  		<div class="col-sm-11">
				  			<div class="col-sm-10  text-right col-sm-offset-2" >
					  			<div class="panel panel-default">
								  <div class="panel-body">
										<p class="text-primary" style="border-bottom:solid 1px #ddd">
								  		<span class="label label-info">
								  		评价：$enumUtil.getEnumClass("com.ccconsult.enums.AppriseEnum").getByValue($apprise.apprise).getDescription()
								  		</span>
								  		<span style="float:left;">
								  		创建时间 $date.format("yyyy-MM-dd HH:mm:ss", $apprise.gmtCreate)</span></p>
								  		#if($apprise.memo) $apprise.memo  #else 他很懒，什么也没有写  #end
								  </div>
								</div>
							</div>
				  		</div>
				  		<div class="col-sm-1">
				  			<img src="$link.contextPath/UPLOAD/$!counselorVO.counselor.photo" class="img-rounded" style="width: 60px;height: 60px;">
				  		</div>				  		
				  	</div>
		  		#end
		  	
		  	#end
		  </div>
  		</div>
	</div>
</div>
#end
<div class="modal" id="rejectInnerConsult">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h4 class="modal-title">您拒绝了咨询请求</h4>
      </div>
      <div class="modal-body">
      	<ol>
		  <li>请确认您拒绝了咨询请求</li>
		  <li>您可以用简单的话描述一下您拒绝的原因</li>
		</ol>
		<textarea class="form-control" rows="3">对不起，最近比较忙</textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary" onclick="rejectConsult('$consultBase.consult.id')">确认拒绝</button>
      </div>
    </div>
  </div>
</div>
<script>
	//发送消息
	function sendMessage(){
		jQuery.ajax({
             type: "POST",
             url: "$link.contextPath/sendShotMessage.json",
             data: $('#sendMessageForm').serialize(),
             dataType: "json",
             success: function(data){
             	console.log(data);
             	if(data.result.success==true){
             		window.location.href=window.location.href;
             	}else{
             		alert("发送失败"+data.result.message);
             	}
              }
         });
	}
	//拒绝咨询
	function rejectConsult(consultId){
		jQuery.ajax({
             type: "POST",
             url: "$link.contextPath/counselor/consult/rejectConsult.json",
             data: {'consultId':consultId},
             dataType: "json",
             success: function(data){
             	if(data.result.success==true){
             		console.log(data.result);
             		window.location.reload();
             	}else{
             		alert("发送失败"+data.result.message);
             	}
              }
         });
	}
	
	//接受预约
	function acceptConsult(consultId){
		jQuery.ajax({
             type: "POST",
             url: "$link.contextPath/counselor/consult/acceptConsult.json",
             data: {'consultId':consultId},
             dataType: "json",
             success: function(data){
             	console.log(data);
             	if(data.result.success==true){
             		window.location.reload();
             	}else{
             		alert("发送失败"+data.result.message);
             	}
              }
         });
	}
	
	//完成请求
	function completeConsult(consultId){
		jQuery.ajax({
             type: "POST",
             url: "$link.contextPath/counselor/consult/completeConsult.json",
             data: {'consultId':consultId},
             dataType: "json",
             success: function(data){
             	console.log(data);
             	if(data.result.success==true){
             		window.location.reload();
             	}else{
             		alert("发送失败"+data.result.message);
             	}
              }
         });
	}
	
</script>
